<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGI AI Studio â€“ Powered By Dreamit Getit Technology</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #a78bfa; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #1f2937; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d12;
            color: #e5e7eb;
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Aspect Ratio Selection Styles */
        input[type="radio"]:checked + label {
            background-color: #a78bfa;
            color: #111827;
            border-color: #a78bfa;
        }

        /* Custom file input appearance */
        #enhance-image-upload::file-selector-button,
        #generate-image-upload::file-selector-button {
            @apply bg-violet-600 text-white font-medium py-2 px-4 rounded-lg border-0 cursor-pointer hover:bg-violet-700 transition duration-150;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-violet-400 to-fuchsia-500">
            DIGI AI Studio
        </h1>
        <p class="text-sm md:text-base text-gray-400 mt-2">Powered By Dreamit Getit Technology</p>
    </header>

    <main class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-4 md:p-8">

        <!-- Tab Navigation --><div class="flex border-b border-gray-700 mb-6">
            <button id="tab-generate" onclick="switchTab('generate')"
                    class="tab-button w-1/2 py-3 text-center text-lg font-semibold transition-colors duration-200 rounded-t-lg focus:outline-none"
                    data-tab="generate">
                Generate / Edit Image
            </button>
            <button id="tab-enhance" onclick="switchTab('enhance')"
                    class="tab-button w-1/2 py-3 text-center text-lg font-semibold transition-colors duration-200 rounded-t-lg focus:outline-none"
                    data-tab="enhance">
                Enhance Image
            </button>
        </div>

        <!-- Notification/Error Message Area --><div id="message-box" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

        <!-- Tab Content Containers --><!-- 1. GENERATE / EDIT Tab Content --><div id="content-generate" class="tab-content space-y-6">
            
            <!-- Optional Image Upload for Editing --><div class="space-y-2">
                <label for="generate-image-upload" class="block text-sm font-medium text-gray-300">
                    Optional: Upload Image to Edit (or leave blank for pure generation)
                </label>
                <input type="file" id="generate-image-upload" accept="image/*" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-violet-500 focus:border-violet-500 text-white placeholder-gray-400" onchange="previewGenerateImage(event)">
            </div>
            
            <!-- Generate Image Preview --><div id="generate-preview-container" class="flex justify-center items-center min-h-[100px] border border-dashed border-gray-600 rounded-xl p-4 hidden">
                <img id="generate-original-image" class="max-w-full max-h-[150px] rounded-lg shadow" alt="Original Image Preview">
            </div>

            <div class="space-y-2">
                <label for="generate-prompt" class="block text-sm font-medium text-gray-300">Text Prompt (Describe the image or the *edits* you want)</label>
                <textarea id="generate-prompt" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-violet-500 focus:border-violet-500 text-white placeholder-gray-400 resize-none" placeholder="If editing, describe the changes (e.g., 'Change the sky to a sunset'). If generating, describe the whole scene..."></textarea>
            </div>

            <!-- Aspect Ratio Selection --><div class="space-y-2">
                <p class="block text-sm font-medium text-gray-300">Aspect Ratio (Controls the shape and dimensions of the output)</p>
                <div class="flex flex-wrap gap-2">
                    <!-- Ratio definitions are mapped to width:height pixel dimensions --><div id="ratio-16-9" class="aspect-option" data-ratio="16:9">
                        <input type="radio" id="ratio-16-9-radio" name="aspect-ratio" value="1024:576" checked class="hidden">
                        <label for="ratio-16-9-radio" class="cursor-pointer text-gray-300 bg-gray-700 hover:bg-violet-600/50 border border-gray-600 px-4 py-2 rounded-lg transition-all text-sm">16:9 (Widescreen)</label>
                    </div>
                    <div id="ratio-9-16" class="aspect-option" data-ratio="9:16">
                        <input type="radio" id="ratio-9-16-radio" name="aspect-ratio" value="576:1024" class="hidden">
                        <label for="ratio-9-16-radio" class="cursor-pointer text-gray-300 bg-gray-700 hover:bg-violet-600/50 border border-gray-600 px-4 py-2 rounded-lg transition-all text-sm">9:16 (Vertical)</label>
                    </div>
                    <div id="ratio-1-1" class="aspect-option" data-ratio="1:1">
                        <input type="radio" id="ratio-1-1-radio" name="aspect-ratio" value="1024:1024" class="hidden">
                        <label for="ratio-1-1-radio" class="cursor-pointer text-gray-300 bg-gray-700 hover:bg-violet-600/50 border border-gray-600 px-4 py-2 rounded-lg transition-all text-sm">1:1 (Square)</label>
                    </div>
                    <div id="ratio-4-5" class="aspect-option" data-ratio="4:5">
                        <input type="radio" id="ratio-4-5-radio" name="aspect-ratio" value="832:1024" class="hidden">
                        <label for="ratio-4-5-radio" class="cursor-pointer text-gray-300 bg-gray-700 hover:bg-violet-600/50 border border-gray-600 px-4 py-2 rounded-lg transition-all text-sm">4:5 (Tall Post)</label>
                    </div>
                    <div id="ratio-3-2" class="aspect-option" data-ratio="3:2">
                        <input type="radio" id="ratio-3-2-radio" name="aspect-ratio" value="1024:683" class="hidden">
                        <label for="ratio-3-2-radio" class="cursor-pointer text-gray-300 bg-gray-700 hover:bg-violet-600/50 border border-gray-600 px-4 py-2 rounded-lg transition-all text-sm">3:2 (Classic Wide)</label>
                    </div>
                </div>
            </div>

            <button id="generate-button" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-150 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-violet-500 focus:ring-opacity-50"
                    onclick="generateImage()">
                Generate / Edit Image
            </button>

            <!-- Image Output Area --><div id="generate-output-container" class="mt-8 pt-4 border-t border-gray-700 min-h-[300px] flex flex-col justify-center items-center">
                <img id="generated-image" class="max-w-full max-h-[70vh] rounded-xl shadow-lg border-2 border-gray-700 hidden" alt="Generated AI Image">
                <button id="download-generated-image" class="mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition duration-150 transform hover:scale-105 hidden" onclick="downloadImage('generated-image', 'generated_digi_ai_studio')">
                    Download Image
                </button>
                <p id="generate-placeholder" class="text-gray-500 italic">Your generated or edited image will appear here.</p>
                <div id="generate-loading" class="hidden flex flex-col items-center">
                    <div class="spinner"></div>
                    <p class="mt-3 text-violet-400">Processing image, please wait...</p>
                </div>
            </div>
        </div>

        <!-- 2. ENHANCE Tab Content --><div id="content-enhance" class="tab-content hidden space-y-6">
            <div class="space-y-2">
                <label for="enhance-image-upload" class="block text-sm font-medium text-gray-300">Upload Image to Enhance</label>
                <input type="file" id="enhance-image-upload" accept="image/*" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-violet-500 focus:border-violet-500 text-white placeholder-gray-400" onchange="previewEnhanceImage(event)">
            </div>

            <div id="enhance-preview-container" class="flex justify-center items-center min-h-[200px] border border-dashed border-gray-600 rounded-xl p-4">
                <img id="enhance-original-image" class="max-w-full max-h-[300px] rounded-lg shadow hidden" alt="Original Image Preview">
                <p id="enhance-placeholder" class="text-gray-500 italic">Upload an image to see the preview.</p>
            </div>

            <button id="enhance-button" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-150 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-violet-500 focus:ring-opacity-50 disabled:opacity-50"
                    onclick="enhanceImage()" disabled>
                Convert to Ultra HD
            </button>

            <!-- Enhanced Image Output Area --><div id="enhance-output-container" class="mt-8 pt-4 border-t border-gray-700 min-h-[300px] flex flex-col justify-center items-center">
                <img id="enhanced-image" class="max-w-full max-h-[70vh] rounded-xl shadow-lg border-2 border-gray-700 hidden" alt="Enhanced AI Image">
                <button id="download-enhanced-image" class="mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition duration-150 transform hover:scale-105 hidden" onclick="downloadImage('enhanced-image', 'enhanced_digi_ai_studio')">
                    Download Image
                </button>
                <p id="enhanced-placeholder" class="text-gray-500 italic">Your enhanced Ultra HD image will appear here.</p>
                <div id="enhance-loading" class="hidden flex flex-col items-center">
                    <div class="spinner"></div>
                    <p class="mt-3 text-violet-400">Enhancing to Ultra HD, please wait...</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        const apiKey = ""; // API key is provided at runtime.
        const TEXT_TO_IMAGE_MODEL = "imagen-4.0-generate-001"; // For pure text-to-image
        const IMAGE_EDITING_MODEL = "gemini-2.5-flash-image-preview"; // For image-to-image (editing and enhancing)
        const ENHANCE_PROMPT = "Convert this image into an ultra-realistic, high-definition, sharp, and detailed version. Enhance the clarity, color, and texture, providing a true Ultra HD feel.";

        // --- Utility Functions ---

        /** Shows a message box for errors or notifications. */
        function showMessage(text, isError = true) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = `p-3 mb-4 text-sm rounded-lg ${isError ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`;
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 5000);
        }

        /** Converts a File object to a Base64 string for the API. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extract only the base64 part (after "data:image/jpeg;base64,")
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Handles exponential backoff for API calls. */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API call failed with status ${response.status}: ${response.statusText}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /** Downloads an image from an img element. */
        function downloadImage(imgElementId, filenamePrefix) {
            const imgElement = document.getElementById(imgElementId);
            const imageUrl = imgElement.src;

            if (imageUrl && imageUrl !== '#') {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `${filenamePrefix}_${Date.now()}.png`; // Unique filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showMessage("No image to download.", true);
            }
        }

        // --- Tab Switching Logic ---

        /** Initializes the tab state based on the current active tab. */
        function initTabs() {
            // Apply initial styles for the active tab (Generate)
            const generateTab = document.getElementById('tab-generate');
            generateTab.classList.add('border-violet-500', 'text-violet-400');
            generateTab.classList.remove('text-gray-400', 'hover:text-violet-400');
        }

        /** Switches the displayed content and updates tab styling. */
        function switchTab(activeTabId) {
            const tabs = ['generate', 'enhance'];
            tabs.forEach(tabId => {
                const button = document.getElementById(`tab-${tabId}`);
                const content = document.getElementById(`content-${tabId}`);

                if (tabId === activeTabId) {
                    // Activate tab
                    button.classList.add('border-violet-500', 'text-violet-400');
                    button.classList.remove('text-gray-400', 'hover:text-violet-400');
                    content.classList.remove('hidden');
                } else {
                    // Deactivate tab
                    button.classList.remove('border-violet-500', 'text-violet-400');
                    button.classList.add('text-gray-400', 'hover:text-violet-400');
                    content.classList.add('hidden');
                }
            });
            document.getElementById('message-box').style.display = 'none';
        }

        // --- GENERATE Tab Previews ---

        /** Previews the uploaded image in the Generate tab. */
        function previewGenerateImage(event) {
            const file = event.target.files[0];
            const originalImageEl = document.getElementById('generate-original-image');
            const placeholderContainer = document.getElementById('generate-preview-container');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImageEl.src = e.target.result;
                    originalImageEl.classList.remove('hidden');
                    placeholderContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                originalImageEl.classList.add('hidden');
                placeholderContainer.classList.add('hidden');
            }
        }

        // --- GENERATE Tab Logic (Text-to-Image / Image-to-Image Editing) ---

        /** Handles the image generation or editing API call. */
        async function generateImage() {
            const prompt = document.getElementById('generate-prompt').value.trim();
            const fileInput = document.getElementById('generate-image-upload');
            const file = fileInput.files[0];
            const aspectRatioValue = document.querySelector('input[name="aspect-ratio"]:checked').value;
            const aspectRatioName = document.querySelector('input[name="aspect-ratio"]:checked').parentElement.getAttribute('data-ratio');
            
            if (!prompt) {
                showMessage("Please enter a text prompt to generate or edit the image.");
                return;
            }

            const button = document.getElementById('generate-button');
            const loading = document.getElementById('generate-loading');
            const imageEl = document.getElementById('generated-image');
            const downloadButton = document.getElementById('download-generated-image');
            const placeholderEl = document.getElementById('generate-placeholder');

            // 1. Set Loading State
            button.disabled = true;
            button.textContent = file ? "Editing Image..." : "Generating Image...";
            placeholderEl.classList.add('hidden');
            imageEl.classList.add('hidden');
            downloadButton.classList.add('hidden'); // Hide download button during processing
            loading.classList.remove('hidden');
            document.getElementById('message-box').style.display = 'none';

            let apiUrl;
            let payload;
            let modelUsed;

            try {
                if (file) {
                    // --- MODE 2: Image-to-Image Editing (using Gemini) ---
                    modelUsed = IMAGE_EDITING_MODEL;
                    const base64Image = await fileToBase64(file);
                    
                    // Extract exact pixel dimensions from the selected ratio value
                    const [targetWidth, targetHeight] = aspectRatioValue.split(':');

                    // Stronger prompt instruction to ensure the output size/ratio is respected
                    const editingPrompt = `Edit this image as described: "${prompt}". The output image MUST strictly adhere to the dimensions ${targetWidth}x${targetHeight} pixels, maintaining the exact aspect ratio of ${aspectRatioName}.`;

                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelUsed}:generateContent?key=${apiKey}`;
                    
                    payload = {
                        contents: [
                            {
                                parts: [
                                    { text: editingPrompt },
                                    {
                                        inlineData: {
                                            mimeType: file.type,
                                            data: base64Image
                                        }
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            responseModalities: ['TEXT', 'IMAGE']
                        },
                    };

                } else {
                    // --- MODE 1: Text-to-Image Generation (using Imagen) ---
                    modelUsed = TEXT_TO_IMAGE_MODEL;
                    const [width, height] = aspectRatioValue.split(':');
                    
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelUsed}:predict?key=${apiKey}`;

                    payload = {
                        instances: {
                            prompt: prompt,
                            // Imagen is used for pure generation and guarantees the size matching
                            aspect_ratio: `${width}:${height}`
                        },
                        parameters: { sampleCount: 1 }
                    };
                }
                
                // 2. Perform API Call
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                // 3. Extract Image Data (Extraction differs based on model)
                let base64Data;
                if (modelUsed === IMAGE_EDITING_MODEL) {
                    // Gemini (Image-to-Image) extraction
                    base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                } else {
                    // Imagen (Text-to-Image) extraction
                    base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                }

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    imageEl.src = imageUrl;
                    imageEl.classList.remove('hidden');
                    downloadButton.classList.remove('hidden'); // Show download button
                    showMessage(`Image processed successfully via ${modelUsed}!`, false);
                } else {
                    // Handle API error or empty prediction
                    const errorMessage = result.error?.message || "Processing failed. Please check the prompt and image.";
                    showMessage(`Error: ${errorMessage}`);
                }

            } catch (error) {
                console.error("Image processing error:", error);
                showMessage("An unexpected error occurred during image processing. Please check the console.");
            } finally {
                // 4. Reset State
                button.disabled = false;
                button.textContent = "Generate / Edit Image";
                loading.classList.add('hidden');
                if (imageEl.classList.contains('hidden')) {
                    placeholderEl.classList.remove('hidden');
                }
            }
        }

        // --- ENHANCE Tab Logic (Image-to-Image) ---

        /** Previews the uploaded image and enables the enhance button. */
        function previewEnhanceImage(event) {
            const file = event.target.files[0];
            const originalImageEl = document.getElementById('enhance-original-image');
            const placeholderEl = document.getElementById('enhance-placeholder');
            const enhanceButton = document.getElementById('enhance-button');
            const enhancedImageEl = document.getElementById('enhanced-image');
            const enhancedPlaceholderEl = document.getElementById('enhanced-placeholder');
            const downloadButton = document.getElementById('download-enhanced-image');


            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImageEl.src = e.target.result;
                    originalImageEl.classList.remove('hidden');
                    placeholderEl.classList.add('hidden');
                    enhanceButton.disabled = false;
                    // Clear previous enhanced result
                    enhancedImageEl.classList.add('hidden');
                    enhancedPlaceholderEl.classList.remove('hidden');
                    downloadButton.classList.add('hidden'); // Hide download button
                };
                reader.readAsDataURL(file);
            } else {
                originalImageEl.classList.add('hidden');
                placeholderEl.classList.remove('hidden');
                enhanceButton.disabled = true;
            }
        }

        /** Handles the image enhancement (Image-to-Image) API call. */
        async function enhanceImage() {
            const fileInput = document.getElementById('enhance-image-upload');
            const file = fileInput.files[0];

            if (!file) {
                showMessage("Please upload an image first.");
                return;
            }

            const button = document.getElementById('enhance-button');
            const loading = document.getElementById('enhance-loading');
            const enhancedImageEl = document.getElementById('enhanced-image');
            const enhancedPlaceholderEl = document.getElementById('enhanced-placeholder');
            const downloadButton = document.getElementById('download-enhanced-image');


            // 1. Set Loading State
            button.disabled = true;
            button.textContent = "Enhancing...";
            enhancedPlaceholderEl.classList.add('hidden');
            enhancedImageEl.classList.add('hidden');
            downloadButton.classList.add('hidden'); // Hide download button during processing
            loading.classList.remove('hidden');
            document.getElementById('message-box').style.display = 'none';

            try {
                const base64Image = await fileToBase64(file);
                
                // Prepare API payload for Gemini (generateContent endpoint for image-to-image)
                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: ENHANCE_PROMPT },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                        
                    },
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_EDITING_MODEL}:generateContent?key=${apiKey}`;

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // 2. Extract Image Data
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    enhancedImageEl.src = imageUrl;
                    enhancedImageEl.classList.remove('hidden');
                    downloadButton.classList.remove('hidden'); // Show download button
                    showMessage("Image enhanced to Ultra HD successfully!", false);
                } else {
                    // Handle API error or empty prediction
                    const errorMessage = result.error?.message || "Enhancement failed. Check the image format.";
                    showMessage(`Error: ${errorMessage}`);
                }

            } catch (error) {
                console.error("Image enhancement error:", error);
                showMessage("An unexpected error occurred during image enhancement. Please check the console.");
            } finally {
                // 3. Reset State
                button.disabled = false;
                button.textContent = "Convert to Ultra HD";
                loading.classList.add('hidden');
                if (enhancedImageEl.classList.contains('hidden')) {
                    enhancedPlaceholderEl.classList.remove('hidden');
                }
            }
        }


        // --- Initialization ---
        window.onload = function() {
            initTabs();
            // Ensure the default tab is selected on load
            switchTab('generate'); 
        };
    </script>
</body>
</html>
